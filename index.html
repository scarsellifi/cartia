<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CARTIA (Online)</title>
    <meta name="description" content="CARTIA is an e-ink friendly AI chat designed for comfortable reading, prompt engineering, and long sessions on screens.">
    <meta property="og:type" content="website">
    <meta property="og:title" content="CARTIA (Online)">
    <meta property="og:description" content="An e-ink friendly AI chat focused on readability, prompt engineering, and low eye strain.">
    <meta property="og:site_name" content="CARTIA">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="CARTIA (Online)">
    <meta name="twitter:description" content="An e-ink friendly AI chat focused on readability, prompt engineering, and low eye strain.">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Colori ottimizzati per e-ink a colori */
            --bg-color: #ffffff;
            --text-color: #000000;
            --border-color: #5a7fa0;
            --button-bg: #5a7fa0;
            --button-hover: #4a6a85;
            --button-text: #ffffff;
            --message-user-bg: #e8f1f8;
            --message-user-border: #5a7fa0;
            --message-assistant-bg: #f0f5e8;
            --message-assistant-border: #7a9a5a;
            --meta-text: #666666;
        }

        body {
            font-family: 'Georgia', 'Times New Roman', serif;
            font-size: 16px;
            line-height: 1.6;
            background: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* API Key Setup Overlay */
        #setupScreen {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: rgba(0, 0, 0, 0.35);
            z-index: 1200;
        }

        #setupScreen.active {
            display: flex;
        }

        .setup-container {
            max-width: 520px;
            width: 100%;
            text-align: center;
            background: var(--bg-color);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 10px 24px rgba(0, 0, 0, 0.18);
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .setup-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 8px;
        }

        .setup-header-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .setup-lang {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .setup-lang-btn {
            width: 36px;
            height: 32px;
            border-radius: 8px;
            border: 2px solid var(--border-color);
            background: var(--bg-color);
            cursor: pointer;
            font-size: 18px;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        .setup-lang-btn.active {
            background: var(--button-bg);
            color: var(--button-text);
            border-color: var(--button-bg);
        }

        .setup-container h1 {
            margin: 0;
            color: var(--border-color);
        }

        .setup-container p {
            margin-bottom: 20px;
            color: var(--meta-text);
        }

        .project-blurb {
            margin: 12px 0 18px;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: #f7f9fb;
            color: var(--text-color);
            font-size: 14px;
            line-height: 1.5;
        }

        .setup-actions {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin: 8px 0 10px;
        }

        .setup-actions button {
            padding: 6px 10px;
            border-radius: 8px;
            border: 2px solid var(--border-color);
            background: var(--bg-color);
            color: var(--text-color);
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
        }

        .setup-container input {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .setup-container button {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            background: var(--button-bg);
            color: var(--button-text);
            cursor: pointer;
            border-radius: 8px;
        }

        .setup-container button:active {
            background: var(--button-hover);
        }

        .setup-container a {
            display: block;
            margin-top: 15px;
            color: var(--border-color);
        }

        .api-key-info {
            margin-top: 20px;
            padding: 15px;
            background: #fff8e1;
            border: 2px solid #ffc107;
            border-radius: 8px;
            text-align: left;
            font-size: 14px;
        }

        .api-key-info strong {
            display: block;
            margin-bottom: 10px;
        }

        .setup-credit {
            margin-top: 20px;
            padding: 15px;
            background: var(--message-assistant-bg);
            border: 2px solid var(--message-assistant-border);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
        }

        .setup-credit-label {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--meta-text);
            margin-bottom: 5px;
        }

        .setup-credit-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--text-color);
        }
        .setup-credit:active {
            background: #f0f0f0;
        }

        .setup-close {
            background: none;
            border: none;
            color: var(--border-color);
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            cursor: pointer;
            padding: 6px 4px;
        }

        .demo-banner {
            background: #fff8e1;
            border-bottom: 2px solid #ffc107;
            color: #4a3b00;
            padding: 10px 15px;
            font-size: 14px;
            display: none;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            flex-wrap: wrap;
        }

        .demo-banner.active {
            display: flex;
        }

        .demo-banner button {
            padding: 6px 10px;
            border-radius: 8px;
            border: 2px solid #ffc107;
            background: #fff3cd;
            cursor: pointer;
            font-weight: bold;
        }

        /* Main App */
        #app {
            display: none;
            height: 100vh;
            flex-direction: column;
        }

        #app.active {
            display: flex;
        }

        /* Top Bar - Input Area */
        #topBar {
            display: flex;
            gap: 10px;
            padding: 15px;
            border-bottom: 2px solid var(--border-color);
            background: var(--bg-color);
            align-items: center;
            flex-wrap: wrap;
        }

        #topActions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        #homeBtn,
        #newChatBtn,
        #cloneChatBtn,
        #apiKeyBtn {
            flex-shrink: 0;
            width: 44px;
            height: 44px;
            border: none;
            background: var(--button-bg);
            color: var(--button-text);
            font-size: 24px;
            cursor: pointer;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #apiKeyBtn {
            font-size: 18px;
        }

        #homeBtn:active,
        #newChatBtn:active,
        #cloneChatBtn:active,
        #apiKeyBtn:active {
            background: var(--button-hover);
        }

        #messageInput {
            flex: 1;
            padding: 12px;
            font-size: 16px;
            font-family: inherit;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            resize: none;
            min-height: 44px;
            max-height: 100px;
        }

        #sendBtn {
            flex-shrink: 0;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            background: var(--button-bg);
            color: var(--button-text);
            cursor: pointer;
            border-radius: 8px;
            min-height: 44px;
        }

        #sendBtn:active:not(:disabled) {
            background: var(--button-hover);
        }

        #sendBtn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .prompt-hint {
            padding: 8px 15px 0;
            font-size: 12px;
            color: var(--meta-text);
        }

        /* Prompt Panel */
        #promptPanel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 10px;
            padding: 12px 15px;
            border-bottom: 2px solid var(--border-color);
            background: #fafafa;
        }

        .prompt-field label {
            display: block;
            font-size: 12px;
            font-weight: bold;
            letter-spacing: 0.06em;
            text-transform: uppercase;
            margin-bottom: 6px;
        }

        .prompt-field textarea {
            width: 100%;
            min-height: 70px;
            padding: 10px;
            font-size: 14px;
            font-family: inherit;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            resize: vertical;
        }

        /* Messages Area */
        #messagesContainer {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .message {
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 12px;
            border-left: 4px solid;
        }

        .message.user {
            background: var(--message-user-bg);
            border-left-color: var(--message-user-border);
        }

        .message.assistant {
            background: var(--message-assistant-bg);
            border-left-color: var(--message-assistant-border);
        }

        .message-role {
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .message-content {
            word-wrap: break-word;
        }

        .message-meta {
            margin-top: 8px;
            font-size: 12px;
            color: var(--meta-text);
        }

        /* Markdown styling */
        .message-content h1, .message-content h2, .message-content h3 {
            margin-top: 15px;
            margin-bottom: 8px;
        }

        .message-content p {
            margin-bottom: 10px;
        }

        .message-content pre {
            background: #f5f5f5;
            border: 1px solid var(--border-color);
            padding: 10px;
            overflow-x: auto;
            margin-bottom: 10px;
        }

        .message-content code {
            background: #f5f5f5;
            padding: 2px 5px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }

        .message-content pre code {
            background: none;
            padding: 0;
        }

        .message-content ul, .message-content ol {
            margin-left: 20px;
            margin-bottom: 10px;
        }

        .message-content li {
            margin-bottom: 5px;
        }

        .message-content blockquote {
            border-left: 3px solid var(--border-color);
            padding-left: 15px;
            margin: 10px 0;
            color: #666;
        }

        .loading-text {
            font-style: italic;
            color: var(--meta-text);
        }

        /* Bottom Bar - Controls */
        #bottomBar {
            display: flex;
            gap: 8px;
            padding: 12px;
            border-top: 2px solid var(--border-color);
            background: var(--bg-color);
            align-items: center;
            flex-wrap: wrap;
        }

        .nav-controls {
            display: flex;
            gap: 5px;
        }

        .nav-btn {
            width: 44px;
            height: 44px;
            border: 2px solid var(--border-color);
            background: var(--bg-color);
            cursor: pointer;
            border-radius: 8px;
            font-weight: bold;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-btn:active:not(:disabled) {
            background: #f0f0f0;
        }

        .nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        #modelSelector {
            flex: 1;
            min-width: 120px;
            padding: 10px;
            font-size: 14px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-color);
            cursor: pointer;
        }

        .font-controls {
            display: flex;
            gap: 5px;
        }

        .font-btn {
            width: 44px;
            height: 44px;
            border: 2px solid var(--border-color);
            background: var(--bg-color);
            cursor: pointer;
            border-radius: 8px;
            font-weight: bold;
            font-size: 14px;
        }

        .font-btn:active {
            background: #f0f0f0;
        }

        #autoScrollToggle {
            width: 44px;
            height: 44px;
            border: 2px solid var(--border-color);
            background: var(--bg-color);
            cursor: pointer;
            border-radius: 8px;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #autoScrollToggle.active {
            background: var(--message-assistant-bg);
            border-color: var(--message-assistant-border);
        }

        #autoScrollToggle:active {
            background: #f0f0f0;
        }

        #reasoningToggle {
            width: 44px;
            height: 44px;
            border: 2px solid var(--border-color);
            background: var(--bg-color);
            cursor: pointer;
            border-radius: 8px;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #reasoningToggle.active {
            background: var(--message-assistant-bg);
            border-color: var(--message-assistant-border);
        }

        #reasoningToggle:active {
            background: #f0f0f0;
        }

        #historyBtn {
            width: 44px;
            height: 44px;
            border: 2px solid var(--border-color);
            background: var(--bg-color);
            cursor: pointer;
            border-radius: 8px;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #historyBtn:active {
            background: #f0f0f0;
        }

        #tourBtn {
            width: 44px;
            height: 44px;
            border: 2px solid var(--border-color);
            background: var(--bg-color);
            cursor: pointer;
            border-radius: 8px;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #tourBtn:active {
            background: #f0f0f0;
        }

        #exportBtn {
            width: 44px;
            height: 44px;
            border: 2px solid var(--border-color);
            background: var(--bg-color);
            cursor: pointer;
            border-radius: 8px;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #exportBtn:active {
            background: #f0f0f0;
        }

        #langToggle {
            min-width: 56px;
            height: 44px;
            padding: 0 10px;
            border: 2px solid var(--border-color);
            background: var(--bg-color);
            cursor: pointer;
            border-radius: 8px;
            font-size: 13px;
            font-weight: bold;
        }

        #langToggle:active {
            background: #f0f0f0;
        }

        #pageViewBtn {
            width: 44px;
            height: 44px;
            border: 2px solid var(--border-color);
            background: var(--bg-color);
            cursor: pointer;
            border-radius: 8px;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #pageViewBtn:active {
            background: #f0f0f0;
        }

        #creditDisplay {
            font-size: 14px;
            font-weight: bold;
            padding: 10px;
            white-space: nowrap;
            cursor: pointer;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-color);
            transition: background 0.2s;
        }

        #creditDisplay:active {
            background: #f0f0f0;
        }

        /* Modal Overlay */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-color);
            width: min(92vw, 600px);
            max-height: 88vh;
            border-radius: 12px;
            padding: 20px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }

        .modal-header h2 {
            font-size: 20px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        .conversation-item {
            padding: 15px;
            margin-bottom: 10px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
        }

        .conversation-item:hover {
            background: #f5f5f5;
        }

        .conversation-title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .conversation-meta {
            font-size: 12px;
            color: var(--meta-text);
        }

        .page-modal {
            display: flex;
            flex-direction: column;
            gap: 12px;
            height: 80vh;
            max-height: 80vh;
            overflow: hidden;
        }

        .page-meta {
            font-size: 12px;
            color: var(--meta-text);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .page-body {
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 14px;
            background: #fafafa;
            overflow: hidden;
            flex: 1;
            min-height: 0;
        }

        .page-body p {
            margin-bottom: 12px;
        }

        .page-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .page-font-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .page-font-btn {
            width: 44px;
            height: 36px;
            border: 2px solid var(--border-color);
            background: var(--bg-color);
            cursor: pointer;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .page-font-btn:active {
            background: #f0f0f0;
        }

        .page-nav-btn {
            width: 54px;
            height: 44px;
            border: 2px solid var(--border-color);
            background: var(--bg-color);
            cursor: pointer;
            border-radius: 8px;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .page-nav-btn:active:not(:disabled) {
            background: #f0f0f0;
        }

        .page-nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .page-counter {
            font-size: 12px;
            font-weight: bold;
            color: var(--text-color);
        }

        .page-empty {
            text-align: center;
            color: var(--meta-text);
            padding: 30px 10px;
        }

        .page-measure {
            position: absolute;
            visibility: hidden;
            left: -9999px;
            top: 0;
            height: auto;
            overflow: visible;
        }

        /* Hidden */
        .hidden {
            display: none !important;
        }

        .reasoning-toast {
            position: fixed;
            right: 14px;
            bottom: calc(60px + env(safe-area-inset-bottom, 0px));
            padding: 8px 12px;
            border-radius: 999px;
            border: 2px solid var(--border-color);
            background: var(--bg-color);
            color: var(--text-color);
            font-size: 12px;
            font-weight: bold;
            box-shadow: 0 6px 14px rgba(0, 0, 0, 0.12);
            z-index: 910;
        }

        .notice-text {
            font-size: 15px;
            line-height: 1.6;
        }

        .notice-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 20px;
            gap: 10px;
        }

        .notice-btn {
            padding: 10px 16px;
            border-radius: 8px;
            border: 2px solid var(--border-color);
            background: var(--button-bg);
            color: var(--button-text);
            font-weight: bold;
            cursor: pointer;
        }

        .notice-btn:active {
            background: var(--button-hover);
        }

        /* Prompt toggle (mobile) */
        .prompt-toggle {
            padding: 12px 16px;
            border-radius: 999px;
            border: 2px solid var(--border-color);
            background: var(--button-bg);
            color: var(--button-text);
            font-weight: bold;
            font-size: 14px;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            box-shadow: 0 6px 14px rgba(0, 0, 0, 0.18);
        }

        .prompt-toggle:active {
            background: var(--button-hover);
        }

        .bottom-toggle {
            padding: 10px 14px;
            border-radius: 999px;
            border: 2px solid var(--border-color);
            background: var(--bg-color);
            color: var(--text-color);
            font-weight: bold;
            font-size: 13px;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            box-shadow: 0 6px 14px rgba(0, 0, 0, 0.12);
        }

        .bottom-toggle:active {
            background: #f0f0f0;
        }

        .floating-toggles {
            position: fixed;
            right: 14px;
            bottom: calc(12px + env(safe-area-inset-bottom, 0px) + var(--bottom-bar-offset, 0px));
            display: none;
            flex-direction: column;
            gap: 10px;
            z-index: 900;
        }

        .online-badge {
            display: inline-block;
            background: #4caf50;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
            margin-left: 8px;
            vertical-align: middle;
        }

        .guide-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.4);
            z-index: 2000;
        }

        .guide-overlay.active {
            display: block;
        }

        .guide-popover {
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-color);
            color: var(--text-color);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            max-width: 360px;
            width: min(92vw, 360px);
            padding: 14px;
            box-shadow: 0 10px 24px rgba(0, 0, 0, 0.2);
            z-index: 2001;
        }

        .guide-title {
            font-weight: bold;
            margin-bottom: 6px;
        }

        .guide-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            margin-top: 12px;
            position: relative;
            z-index: 2002;
        }

        .guide-actions button {
            padding: 8px 12px;
            border-radius: 8px;
            border: 2px solid var(--border-color);
            background: var(--bg-color);
            cursor: pointer;
            font-weight: bold;
        }

        .guide-actions .primary {
            background: var(--button-bg);
            color: var(--button-text);
            border-color: var(--button-bg);
        }

        .guide-highlight {
            outline: 3px solid var(--border-color);
            outline-offset: 4px;
            position: relative;
            z-index: 1301;
        }

        @media (max-width: 720px) {
            body {
                --bottom-bar-offset: 78px;
            }

            #topBar {
                padding: 10px 12px 8px;
            }

            #topActions {
                width: 100%;
                order: 2;
                justify-content: flex-start;
                gap: 6px;
            }

            #homeBtn,
            #newChatBtn,
            #cloneChatBtn,
            #apiKeyBtn {
                width: 36px;
                height: 36px;
                font-size: 14px;
            }

            #apiKeyBtn {
                font-size: 12px;
            }

            #messageInput {
                order: 1;
            }

            #sendBtn {
                order: 1;
            }

            #promptPanel {
                grid-template-columns: 1fr;
            }

            .prompt-toggle {
                display: flex;
            }

            .bottom-toggle {
                display: flex;
            }

            .floating-toggles {
                display: flex;
            }

            body.prompt-collapsed #promptPanel,
            body.prompt-collapsed .prompt-hint {
                display: none;
            }

            body.bottom-collapsed #bottomBar {
                display: none;
            }

            body.bottom-collapsed {
                --bottom-bar-offset: 8px;
            }

            #topBar,
            #bottomBar {
                position: sticky;
                z-index: 5;
            }

            #topBar {
                top: 0;
            }

            #bottomBar {
                bottom: 0;
            }

            #messagesContainer {
                padding-bottom: calc(20px + var(--bottom-bar-offset));
            }

            body.bottom-collapsed #messagesContainer {
                padding-bottom: 20px;
            }

            .modal-content {
                width: 94vw;
                max-height: 92vh;
                padding: 16px;
                overflow-y: auto;
            }

            .page-modal {
                height: 86vh;
                max-height: 86vh;
            }

            .setup-container {
                width: 94vw;
            }

            .guide-popover {
                width: 92vw;
                max-width: 92vw;
                padding: 12px;
            }
        }
    </style>
</head>
<body>
    <!-- API Key Setup Overlay -->
    <div id="setupScreen" aria-hidden="true" inert>
        <div class="setup-container">
            <div class="setup-header">
                <h1>CARTIA <span class="online-badge">ONLINE</span></h1>
                <div class="setup-header-actions">
                    <div class="setup-lang" aria-label="Language">
                        <button id="setupLangEn" class="setup-lang-btn" type="button" title="English">üá¨üáß</button>
                        <button id="setupLangIt" class="setup-lang-btn" type="button" title="Italiano">üáÆüáπ</button>
                    </div>
                    <button class="setup-close" id="setupCloseBtn" title="Chiudi" data-i18n="setup.close">Chiudi</button>
                </div>
            </div>
            <div class="project-blurb" data-i18n-html="setup.blurb">
                Un progetto di <strong>Marco Scarselli</strong>, pensato per chi soffre di secchezza oculare e passa molte ore davanti al monitor:
                una chat studiata per gli schermi e-ink, utilizzabile anche su PC e smartphone.
            </div>
            <div class="setup-actions">
                <button id="setupTourBtn" type="button" data-i18n="guide.launch">Guida</button>
                <button id="setupHideBtn" type="button" data-i18n="setup.demoContinue">Continua demo</button>
            </div>
            <p data-i18n="setup.prompt">Inserisci la tua chiave API di OpenRouter per iniziare. La chiave viene salvata solo nel tuo browser.</p>
            <input type="password" id="apiKeyInput" placeholder="sk-or-v1-..." autocomplete="off" data-i18n-placeholder="setup.apiPlaceholder">
            <button id="saveApiKeyBtn" data-i18n="setup.saveStart">Salva e Inizia</button>
            <a href="https://openrouter.ai/keys" target="_blank" data-i18n="setup.getKey">Ottieni una chiave API su OpenRouter</a>
            <div class="api-key-info">
                <strong data-i18n="setup.securityTitle">Nota sulla sicurezza:</strong>
                <span data-i18n="setup.securityBody">La chiave API viene salvata in localStorage nel tuo browser. Tutte le chiamate API vengono fatte direttamente dal tuo browser a OpenRouter.</span>
            </div>
            <div id="setupCredit" class="setup-credit hidden">
                <div class="setup-credit-label" data-i18n="credit.label">Credito Residuo</div>
                <div id="setupCreditValue" class="setup-credit-value">$-.--</div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="app">
        <div id="demoBanner" class="demo-banner">
            <span data-i18n="demo.banner">Modalit√† demo: inserisci la chiave per iniziare.</span>
            <button id="demoBannerBtn" data-i18n="demo.insertKey">Inserisci chiave</button>
            <button id="demoTourBtn" data-i18n="guide.launch">Guida</button>
        </div>
        <!-- Top Bar -->
        <div id="topBar">
            <div id="topActions">
                <button id="homeBtn" title="Torna alla home" data-i18n-title="top.homeTitle">üè†</button>
                <button id="newChatBtn" title="Nuova Chat (azzera i prompt)" data-i18n-title="top.newChatTitle">üí¨</button>
                <button id="cloneChatBtn" title="Nuova Chat (clona prompt)" data-i18n-title="top.cloneChatTitle">CL</button>
                <button id="apiKeyBtn" title="Cambia API Key" data-i18n-title="top.apiKeyTitle">üîë</button>
            </div>
            <textarea id="messageInput" placeholder="Scrivi un messaggio..." data-i18n-placeholder="chat.inputPlaceholder"></textarea>
            <button id="sendBtn" data-i18n="chat.send">INVIA</button>
        </div>

        <div class="prompt-hint" data-i18n-html="prompt.hint">Nuova chat: resetta System Prompt, Context e Dati. <span class="online-badge">ONLINE</span></div>

        <!-- Prompt Panel -->
        <div id="promptPanel">
            <div class="prompt-field">
                <label for="systemPrompt" data-i18n="prompt.systemLabel">System Prompt</label>
                <textarea id="systemPrompt" placeholder="Regole globali, stile, limiti..." data-i18n-placeholder="prompt.systemPlaceholder"></textarea>
            </div>
            <div class="prompt-field">
                <label for="contextPrompt" data-i18n="prompt.contextLabel">Context</label>
                <textarea id="contextPrompt" placeholder="Informazioni utili, dati, scenario..." data-i18n-placeholder="prompt.contextPlaceholder"></textarea>
            </div>
            <div class="prompt-field">
                <label for="examplesPrompt" data-i18n="prompt.examplesLabel">Esempi Di Output</label>
                <textarea id="examplesPrompt" placeholder="Esempi del formato o dello stile atteso..." data-i18n-placeholder="prompt.examplesPlaceholder"></textarea>
            </div>
        </div>

        <!-- Messages -->
        <div id="messagesContainer">
            <div id="messages"></div>
        </div>

        <!-- Bottom Bar -->
        <div id="bottomBar">
            <div class="nav-controls">
                <button class="nav-btn" id="prevMsg" title="Messaggio precedente" data-i18n-title="nav.prevTitle">‚Üë</button>
                <button class="nav-btn" id="nextMsg" title="Messaggio successivo" data-i18n-title="nav.nextTitle">‚Üì</button>
            </div>
            <select id="modelSelector"></select>
            <div class="font-controls">
                <button class="font-btn" id="fontDecrease">A-</button>
                <button class="font-btn" id="fontIncrease">A+</button>
            </div>
            <button id="reasoningToggle" class="hidden" title="Reasoning: OFF">üß†</button>
            <button id="autoScrollToggle" title="Toggle auto-scroll" data-i18n-title="nav.autoScrollTitle">üëÅÔ∏è</button>
            <button id="exportBtn" title="Export chat (MD)" data-i18n-title="nav.exportTitle">‚¨áÔ∏è</button>
            <button id="pageViewBtn" title="Modal pagine" data-i18n-title="nav.pageViewTitle">üìñ</button>
            <button id="tourBtn" title="Guida passo passo" data-i18n-title="guide.buttonTitle">‚ùî</button>
            <button id="historyBtn" title="Storico chat" data-i18n-title="history.title">üïò</button>
            <button id="langToggle" title="Cambia lingua" data-i18n-title="lang.toggleTitle">IT</button>
            <div id="creditDisplay" title="Credito residuo (clicca per aggiornare)" data-i18n-title="credit.title">$-.--</div>
        </div>
    </div>

    <div class="floating-toggles" aria-label="Controlli rapidi" data-i18n-aria-label="floating.label">
        <button id="promptToggle" class="prompt-toggle" aria-expanded="true" title="Nascondi prompt" data-i18n="floating.promptToggle" data-i18n-title="floating.promptToggleTitle">Chat</button>
        <button id="bottomToggle" class="bottom-toggle" aria-expanded="true" title="Nascondi barra" data-i18n="floating.bottomToggle" data-i18n-title="floating.bottomToggleTitle">Barra</button>
    </div>
    <div id="reasoningToast" class="reasoning-toast hidden" aria-live="polite"></div>
    <div id="guideOverlay" class="guide-overlay" aria-hidden="true">
        <div class="guide-popover" role="dialog" aria-labelledby="guideTitle" aria-describedby="guideDesc">
            <div id="guideTitle" class="guide-title" data-i18n="guide.title">Guida rapida</div>
            <div id="guideDesc"></div>
            <div class="guide-actions">
                <button id="guidePrevBtn" type="button" data-i18n="guide.prev">Indietro</button>
                <button id="guideNextBtn" type="button" class="primary" data-i18n="guide.next">Avanti</button>
                <button id="guideCloseBtn" type="button" data-i18n="guide.close">Chiudi</button>
            </div>
        </div>
    </div>

    <!-- History Modal -->
    <div id="historyModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 data-i18n="history.title">Storico Conversazioni</h2>
                <button class="close-btn" onclick="app.closeHistory()">&times;</button>
            </div>
            <div id="historyList"></div>
        </div>
    </div>

    <!-- Page View Modal -->
    <div id="pageModal" class="modal-overlay" aria-hidden="true">
        <div class="modal-content page-modal">
            <div class="modal-header">
                <h2 data-i18n="pages.title">Modalit√† Pagine</h2>
                <button class="close-btn" onclick="app.closePageView()">&times;</button>
            </div>
            <div class="page-meta">
                <span id="pageMeta" data-i18n="pages.noMessage">Nessun messaggio</span>
                <span id="pageExtra"></span>
            </div>
            <div id="pageBody" class="page-body">
                <div class="page-empty" data-i18n="chat.empty">Nessun messaggio. Inizia una conversazione!</div>
            </div>
            <div class="page-controls">
                <button id="pagePrevBtn" class="page-nav-btn" title="Pagina precedente" data-i18n-title="pages.prevTitle">‚Üê</button>
                <div class="page-font-controls">
                    <button id="pageFontDecrease" class="page-font-btn" title="Testo pi√π piccolo" data-i18n-title="pages.fontDecreaseTitle">A-</button>
                    <div id="pageCounter" class="page-counter">1 / 1</div>
                    <button id="pageFontIncrease" class="page-font-btn" title="Testo pi√π grande" data-i18n-title="pages.fontIncreaseTitle">A+</button>
                </div>
                <button id="pageNextBtn" class="page-nav-btn" title="Pagina successiva" data-i18n-title="pages.nextTitle">‚Üí</button>
            </div>
        </div>
    </div>

    <!-- First Use Notice -->
    <div id="noticeModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 data-i18n="notice.title">Avviso di utilizzo</h2>
                <button class="close-btn" onclick="app.closeNotice()" data-i18n-title="notice.closeTitle" title="Chiudi">&times;</button>
            </div>
            <div class="notice-text">
                <p data-i18n="notice.p1">Questo progetto usa OpenRouter per inviare le richieste ai modelli IA selezionati.</p>
                <p><strong data-i18n="notice.onlineLabel">Versione Online:</strong> <span data-i18n="notice.p2">Le chiamate API vengono fatte direttamente dal tuo browser usando la tua chiave API personale. Il costo viene addebitato sul tuo account OpenRouter.</span></p>
                <p data-i18n="notice.p3">Non inserire dati personali, sensibili o riservati. I contenuti inviati possono essere trattati da servizi esterni e non possiamo garantire la riservatezza assoluta.</p>
                <p data-i18n="notice.p4">Usa lo strumento solo a scopo didattico e sperimentale. L'output dell'IA puo' contenere errori: verifica sempre le informazioni prima di usarle.</p>
            </div>
            <div class="notice-actions">
                <button class="notice-btn" onclick="app.acceptNotice()" data-i18n="notice.accept">Accetto</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@12.0.2/marked.min.js"></script>
    <script>
        function renderMarkdown(content) {
            const safeContent = content ?? '';
            const html = typeof marked !== 'undefined'
                ? marked.parse(safeContent)
                : safeContent;

            if (typeof DOMPurify !== 'undefined') {
                return DOMPurify.sanitize(html, { USE_PROFILES: { html: true } });
            }

            return html;
        }

        const I18N = {
            it: {
                docTitle: 'CARTIA (Online)',
                setup: {
                    close: 'Chiudi',
                    demoContinue: 'Continua demo',
                    blurb: 'Un progetto di <strong>Marco Scarselli</strong>, pensato per chi soffre di secchezza oculare e passa molte ore davanti al monitor: una chat studiata per gli schermi e-ink, utilizzabile anche su PC e smartphone.',
                    prompt: 'Inserisci la tua chiave API di OpenRouter per iniziare. La chiave viene salvata solo nel tuo browser.',
                    apiPlaceholder: 'sk-or-v1-...',
                    saveStart: 'Salva e Inizia',
                    getKey: 'Ottieni una chiave API su OpenRouter',
                    securityTitle: 'Nota sulla sicurezza:',
                    securityBody: 'La chiave API viene salvata in localStorage nel tuo browser. Tutte le chiamate API vengono fatte direttamente dal tuo browser a OpenRouter.'
                },
                demo: {
                    banner: 'Modalita demo: inserisci la chiave per iniziare.',
                    insertKey: 'Inserisci chiave'
                },
                top: {
                    homeTitle: 'Torna alla home',
                    newChatTitle: 'Nuova Chat (azzera i prompt)',
                    cloneChatTitle: 'Nuova Chat (clona prompt)',
                    apiKeyTitle: 'Cambia API Key'
                },
                chat: {
                    inputPlaceholder: 'Scrivi un messaggio...',
                    send: 'INVIA',
                    empty: 'Nessun messaggio. Inizia una conversazione!'
                },
                prompt: {
                    hint: 'Nuova chat: resetta System Prompt, Context e Dati. <span class="online-badge">ONLINE</span>',
                    systemLabel: 'System Prompt',
                    systemPlaceholder: 'Regole globali, stile, limiti...',
                    contextLabel: 'Context',
                    contextPlaceholder: 'Informazioni utili, dati, scenario...',
                    examplesLabel: 'Esempi Di Output',
                    examplesPlaceholder: 'Esempi del formato o dello stile atteso...'
                },
                export: {
                    date: 'Data',
                    prompt: 'Prompt',
                    system: 'System Prompt',
                    context: 'Context',
                    examples: 'Esempi',
                    messages: 'Messaggi',
                    assistant: 'Assistente',
                    user: 'Utente',
                    empty: '_vuoto_',
                    modelLabel: 'Modello',
                    costLabel: 'Costo'
                },
                nav: {
                    prevTitle: 'Messaggio precedente',
                    nextTitle: 'Messaggio successivo',
                    autoScrollTitle: 'Toggle auto-scroll',
                    exportTitle: 'Export chat (MD)',
                    pageViewTitle: 'Modal pagine'
                },
                floating: {
                    label: 'Controlli rapidi',
                    promptToggle: 'Chat',
                    promptToggleTitle: 'Nascondi prompt',
                    promptToggleCollapsed: 'Prompt',
                    promptToggleShow: 'Mostra prompt',
                    bottomToggle: 'Barra',
                    bottomToggleTitle: 'Nascondi barra',
                    bottomToggleCollapsed: 'Barra',
                    bottomToggleExpanded: 'OK',
                    bottomToggleShow: 'Mostra barra'
                },
                guide: {
                    title: 'Guida rapida',
                    launch: 'Guida',
                    prev: 'Indietro',
                    next: 'Avanti',
                    close: 'Chiudi',
                    buttonTitle: 'Guida passo passo',
                    step1Title: 'Controlla la modalita',
                    step1Desc: 'Se sei in demo, inserisci la chiave con üîë.',
                    step2Title: 'Verifica il modello',
                    step2Desc: 'Scegli dal menu in basso quello giusto.',
                    step3Title: 'Scrivi il System Prompt',
                    step3Desc: 'Definisci regole e stile.',
                    step4Title: 'Aggiungi il Context',
                    step4Desc: 'Inserisci dati e scenario.',
                    step5Title: 'Imposta gli Esempi',
                    step5Desc: "Guida formato e tono dell'output.",
                    step6Title: 'Scrivi il messaggio',
                    step6Desc: 'Compila il box in alto.',
                    step7Title: 'Invia',
                    step7Desc: 'Premi INVIA per ottenere la risposta.',
                    step8Title: 'Leggi senza fatica',
                    step8Desc: 'Usa le frecce ‚Üë/‚Üì o üìñ per pagine.',
                    step9Title: 'Regola la leggibilita',
                    step9Desc: 'A- / A+ e auto-scroll üëÅÔ∏è.',
                    step10Title: 'Gestisci la sessione',
                    step10Desc: 'üí¨ nuova chat, CL clona prompt, üïò storico.',
                    done: 'Fine'
                },
                history: {
                    title: 'Storico Conversazioni',
                    empty: 'Nessuna conversazione salvata',
                    messagesLabel: 'messaggi'
                },
                pages: {
                    title: 'Modalita Pagine',
                    noMessage: 'Nessun messaggio',
                    prevTitle: 'Pagina precedente',
                    nextTitle: 'Pagina successiva',
                    fontDecreaseTitle: 'Testo piu piccolo',
                    fontIncreaseTitle: 'Testo piu grande',
                    emptyMessage: 'Messaggio vuoto',
                    meta: 'Messaggio {message}/{total} ‚Ä¢ Pagina {page}/{pages} ‚Ä¢ {role}',
                    counter: '{current} / {total}'
                },
                notice: {
                    title: 'Avviso di utilizzo',
                    closeTitle: 'Chiudi',
                    onlineLabel: 'Versione Online:',
                    p1: 'Questo progetto usa OpenRouter per inviare le richieste ai modelli IA selezionati.',
                    p2: 'Le chiamate API vengono fatte direttamente dal tuo browser usando la tua chiave API personale. Il costo viene addebitato sul tuo account OpenRouter.',
                    p3: 'Non inserire dati personali, sensibili o riservati. I contenuti inviati possono essere trattati da servizi esterni e non possiamo garantire la riservatezza assoluta.',
                    p4: "Usa lo strumento solo a scopo didattico e sperimentale. L'output dell'IA puo contenere errori: verifica sempre le informazioni prima di usarle.",
                    accept: 'Accetto'
                },
                credit: {
                    label: 'Credito Residuo',
                    title: 'Credito residuo (clicca per aggiornare)',
                    unlimited: 'Usato: {value}',
                    remaining: '{value}'
                },
                lang: {
                    toggleTitle: 'Cambia lingua',
                    toggleLabel: 'IT'
                },
                role: {
                    user: 'Tu',
                    assistant: 'Assistente'
                },
                errors: {
                    invalidKey: 'Inserisci una chiave API valida',
                    missingKey: 'API Key non configurata',
                    exportEmpty: 'Nessuna chat da esportare.',
                    changeKeyConfirm: 'Vuoi cambiare la chiave API?',
                    generic: 'Errore: {message}'
                }
            },
            en: {
                docTitle: 'CARTIA (Online)',
                setup: {
                    close: 'Close',
                    demoContinue: 'Continue demo',
                    blurb: 'A project by <strong>Marco Scarselli</strong>, designed for people with dry eyes who spend many hours in front of a monitor: a chat experience tailored for e-ink screens, also usable on PC and smartphone.',
                    prompt: 'Enter your OpenRouter API key to begin. The key is saved only in your browser.',
                    apiPlaceholder: 'sk-or-v1-...',
                    saveStart: 'Save and Start',
                    getKey: 'Get an API key on OpenRouter',
                    securityTitle: 'Security note:',
                    securityBody: 'The API key is stored in localStorage in your browser. All API calls are made directly from your browser to OpenRouter.'
                },
                demo: {
                    banner: 'Demo mode: enter your key to get started.',
                    insertKey: 'Enter key'
                },
                top: {
                    homeTitle: 'Back to home',
                    newChatTitle: 'New Chat (reset prompts)',
                    cloneChatTitle: 'New Chat (clone prompts)',
                    apiKeyTitle: 'Change API Key'
                },
                chat: {
                    inputPlaceholder: 'Write a message...',
                    send: 'SEND',
                    empty: 'No messages yet. Start a conversation!'
                },
                prompt: {
                    hint: 'New chat: resets System Prompt, Context and Data. <span class="online-badge">ONLINE</span>',
                    systemLabel: 'System Prompt',
                    systemPlaceholder: 'Global rules, style, limits...',
                    contextLabel: 'Context',
                    contextPlaceholder: 'Useful information, data, scenario...',
                    examplesLabel: 'Output Examples',
                    examplesPlaceholder: 'Examples of the expected format or style...'
                },
                export: {
                    date: 'Date',
                    prompt: 'Prompt',
                    system: 'System Prompt',
                    context: 'Context',
                    examples: 'Examples',
                    messages: 'Messages',
                    assistant: 'Assistant',
                    user: 'User',
                    empty: '_empty_',
                    modelLabel: 'Model',
                    costLabel: 'Cost'
                },
                nav: {
                    prevTitle: 'Previous message',
                    nextTitle: 'Next message',
                    autoScrollTitle: 'Toggle auto-scroll',
                    exportTitle: 'Export chat (MD)',
                    pageViewTitle: 'Page mode'
                },
                floating: {
                    label: 'Quick controls',
                    promptToggle: 'Chat',
                    promptToggleTitle: 'Hide prompts',
                    promptToggleCollapsed: 'Prompts',
                    promptToggleShow: 'Show prompts',
                    bottomToggle: 'Bar',
                    bottomToggleTitle: 'Hide bar',
                    bottomToggleCollapsed: 'Bar',
                    bottomToggleExpanded: 'OK',
                    bottomToggleShow: 'Show bar'
                },
                guide: {
                    title: 'Quick guide',
                    launch: 'Guide',
                    prev: 'Back',
                    next: 'Next',
                    close: 'Close',
                    buttonTitle: 'Step-by-step guide',
                    step1Title: 'Check the mode',
                    step1Desc: 'If you are in demo mode, enter the key with üîë.',
                    step2Title: 'Verify the model',
                    step2Desc: 'Pick the right one from the menu below.',
                    step3Title: 'Write the System Prompt',
                    step3Desc: 'Define rules and style.',
                    step4Title: 'Add the Context',
                    step4Desc: 'Insert data and scenario.',
                    step5Title: 'Set the Examples',
                    step5Desc: 'Guide the output format and tone.',
                    step6Title: 'Write the message',
                    step6Desc: 'Fill the box at the top.',
                    step7Title: 'Send',
                    step7Desc: 'Press SEND to get the answer.',
                    step8Title: 'Read without strain',
                    step8Desc: 'Use ‚Üë/‚Üì arrows or üìñ for pages.',
                    step9Title: 'Tune readability',
                    step9Desc: 'A- / A+ and auto-scroll üëÅÔ∏è.',
                    step10Title: 'Manage the session',
                    step10Desc: 'üí¨ new chat, CL clone prompts, üïò history.',
                    done: 'Done'
                },
                history: {
                    title: 'Conversation History',
                    empty: 'No saved conversations',
                    messagesLabel: 'messages'
                },
                pages: {
                    title: 'Page Mode',
                    noMessage: 'No message',
                    prevTitle: 'Previous page',
                    nextTitle: 'Next page',
                    fontDecreaseTitle: 'Smaller text',
                    fontIncreaseTitle: 'Larger text',
                    emptyMessage: 'Empty message',
                    meta: 'Message {message}/{total} ‚Ä¢ Page {page}/{pages} ‚Ä¢ {role}',
                    counter: '{current} / {total}'
                },
                notice: {
                    title: 'Usage notice',
                    closeTitle: 'Close',
                    onlineLabel: 'Online version:',
                    p1: 'This project uses OpenRouter to send requests to the selected AI models.',
                    p2: 'API calls are made directly from your browser using your personal API key. The cost is billed on your OpenRouter account.',
                    p3: 'Do not enter personal, sensitive, or confidential data. Content may be processed by external services and we cannot guarantee absolute confidentiality.',
                    p4: 'Use this tool for learning and experimentation only. AI output may contain errors: always verify before using it.',
                    accept: 'Accept'
                },
                credit: {
                    label: 'Remaining Credit',
                    title: 'Remaining credit (click to refresh)',
                    unlimited: 'Used: {value}',
                    remaining: '{value}'
                },
                lang: {
                    toggleTitle: 'Change language',
                    toggleLabel: 'EN'
                },
                role: {
                    user: 'You',
                    assistant: 'Assistant'
                },
                errors: {
                    invalidKey: 'Enter a valid API key',
                    missingKey: 'API key not configured',
                    exportEmpty: 'No chat to export.',
                    changeKeyConfirm: 'Do you want to change the API key?',
                    generic: 'Error: {message}'
                }
            }
        };

        // ===== MODELS CONFIGURATION =====
        const MODELS = [
            { id: 'openai/gpt-5.2-chat', name: 'OpenAI GPT-5.2 Chat', cost: { input: 0.00000175, output: 0.000014 } },
            { id: 'google/gemini-3-flash-preview', name: 'Gemini 3 Flash Preview', cost: { input: 0.0000005, output: 0.000003 } },
            { id: 'google/gemini-2.5-flash', name: 'Gemini 2.5 Flash', cost: { input: 0.0000003, output: 0.0000025 } },
            { id: 'perplexity/sonar', name: 'Perplexity Sonar', cost: { input: 0.000001, output: 0.000001 } },
            { id: 'mistralai/mistral-small-3.2-24b-instruct', name: 'Mistral Small 3.2 (24B)', cost: { input: 0.00000006, output: 0.00000018 } },
            { id: 'mistralai/ministral-8b-2512', name: 'Mistral - OpenSource - Self-hostable (8B)', cost: { input: 0.00000015, output: 0.00000015 } },
            { id: 'google/gemma-3-12b-it', name: 'Gemma - OpenSource - Self-hostable (12B)', cost: { input: 0.00000003, output: 0.0000001 } },
            { id: 'google/gemma-3-27b-it', name: 'Gemma - OpenSource - Self-hostable (27B)', cost: { input: 0.00000004, output: 0.00000015 } },
            { id: 'openai/gpt-4.1', name: 'ChatGPT 4.1', cost: { input: 0.000002, output: 0.000008 } },
            { id: 'deepseek/deepseek-r1', name: 'DeepSeek R1', cost: { input: 0.0000007, output: 0.0000025 } },
            { id: 'qwen/qwen-2.5-72b-instruct', name: 'Qwen 2.5 (72B)', cost: { input: 0.00000012, output: 0.00000039 } },
        ];

        // ===== API KEY MANAGER =====
        class ApiKeyManager {
            constructor() {
                this.storageKey = 'openrouter_api_key_online';
            }

            getApiKey() {
                return localStorage.getItem(this.storageKey);
            }

            setApiKey(key) {
                localStorage.setItem(this.storageKey, key);
            }

            clearApiKey() {
                localStorage.removeItem(this.storageKey);
            }

            hasApiKey() {
                const key = this.getApiKey();
                return key && key.length > 0;
            }
        }

        // ===== MODEL SELECTOR CLASS =====
        class ModelSelector {
            constructor(models) {
                this.models = models;
                this.storageKey = 'selectedModelId_online';
                this.currentModel = this.loadModel(models);
            }

            loadModel(models) {
                const savedId = localStorage.getItem(this.storageKey);
                if (savedId) {
                    const saved = models.find(m => m.id === savedId);
                    if (saved) {
                        return saved;
                    }
                }
                return models[0];
            }

            getModels() {
                return this.models;
            }

            selectModel(modelId) {
                const model = this.models.find(m => m.id === modelId);
                if (model) {
                    this.currentModel = model;
                    localStorage.setItem(this.storageKey, model.id);
                }
            }

            getCurrentModel() {
                return this.currentModel;
            }

            estimateCost(inputTokens, outputTokens) {
                const model = this.currentModel;
                const inputCost = inputTokens * model.cost.input;
                const outputCost = outputTokens * model.cost.output;
                return inputCost + outputCost;
            }
        }

        // ===== CONVERSATION MANAGER CLASS =====
        class ConversationManager {
            constructor() {
                this.conversations = [];
                this.currentConversation = null;
                this.storageKey = 'conversations_online';
                this.load();
            }

            newConversation(promptFields) {
                this.currentConversation = {
                    id: Date.now(),
                    title: 'Nuova Chat',
                    messages: [],
                    promptFields: {
                        systemPrompt: '',
                        contextPrompt: '',
                        examplesPrompt: '',
                        ...promptFields
                    },
                    createdAt: new Date().toISOString()
                };
                return this.currentConversation;
            }

            addMessage(message) {
                if (!this.currentConversation) {
                    this.newConversation();
                }
                this.currentConversation.messages.push(message);

                if (this.currentConversation.title === 'Nuova Chat' && message.role === 'user') {
                    this.currentConversation.title = message.content.substring(0, 50) + '...';
                }

                this.save();
            }

            getCurrentMessages() {
                return this.currentConversation ? this.currentConversation.messages : [];
            }

            saveConversation() {
                if (!this.currentConversation) return;

                const index = this.conversations.findIndex(c => c.id === this.currentConversation.id);
                if (index >= 0) {
                    this.conversations[index] = this.currentConversation;
                } else {
                    this.conversations.push(this.currentConversation);
                }
                this.save();
            }

            loadConversation(id) {
                const conv = this.conversations.find(c => c.id === id);
                if (conv) {
                    if (!conv.promptFields) {
                        conv.promptFields = {
                            systemPrompt: '',
                            contextPrompt: '',
                            examplesPrompt: ''
                        };
                    }
                    this.currentConversation = conv;
                    return conv;
                }
                return null;
            }

            getAllConversations() {
                return this.conversations.sort((a, b) =>
                    new Date(b.createdAt) - new Date(a.createdAt)
                );
            }

            deleteConversation(id) {
                this.conversations = this.conversations.filter(c => c.id !== id);
                this.save();
            }

            save() {
                localStorage.setItem(this.storageKey, JSON.stringify(this.conversations));
            }

            load() {
                const saved = localStorage.getItem(this.storageKey);
                if (saved) {
                    this.conversations = JSON.parse(saved);
                }
            }
        }

        // ===== CHAT CORE CLASS (DIRECT OPENROUTER CALLS) =====
        class ChatCore {
            constructor(modelSelector, apiKeyManager, onStreamUpdate) {
                this.modelSelector = modelSelector;
                this.apiKeyManager = apiKeyManager;
                this.onStreamUpdate = onStreamUpdate;
            }

            async sendMessage(messages, options, onComplete, onError) {
                const model = this.modelSelector.getCurrentModel();
                const apiKey = this.apiKeyManager.getApiKey();

                if (!apiKey) {
                    onError(new Error('API Key non configurata'));
                    return;
                }

                try {
                    const payload = {
                        model: model.id,
                        messages: messages,
                        ...options
                    };

                    // Direct call to OpenRouter API from browser
                    const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`,
                            'HTTP-Referer': window.location.origin,
                            'X-Title': 'CARTIA Online'
                        },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        let errorMessage = errorText || `API Error: ${response.status}`;
                        try {
                            const parsed = JSON.parse(errorText);
                            errorMessage = parsed?.error?.message || parsed?.message || errorMessage;
                        } catch (e) {
                            // Keep fallback if response is not JSON.
                        }
                        throw new Error(`API Error: ${response.status} - ${errorMessage}`);
                    }

                    const data = await response.json();
                    const fullContent = data.choices?.[0]?.message?.content || '';

                    const inputTokens = data.usage?.prompt_tokens ?? Math.ceil(JSON.stringify(messages).length / 4);
                    const outputTokens = data.usage?.completion_tokens ?? Math.ceil(fullContent.length / 4);

                    // Use real cost from OpenRouter if available
                    const cost = data.usage?.cost ?? this.modelSelector.estimateCost(inputTokens, outputTokens);

                    onComplete(fullContent, cost, inputTokens, outputTokens);

                } catch (error) {
                    onError(error);
                }
            }
        }

        // ===== CHAT UI CLASS =====
        class ChatUI {
            constructor(translator) {
                this.t = translator;
                this.fontSize = 16;
                this.currentMessageIndex = -1;
                this.autoScroll = true;
                this.loadFontSize();
                this.loadAutoScroll();
            }

            setTranslator(translator) {
                this.t = translator;
            }

            renderMessage(message) {
                const div = document.createElement('div');
                div.className = `message ${message.role}`;

                const roleDiv = document.createElement('div');
                roleDiv.className = 'message-role';
                roleDiv.textContent = message.role === 'user' ? this.t('role.user') : this.t('role.assistant');

                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';

                if (message.role === 'assistant' && !message.content) {
                    const loadingSpan = document.createElement('span');
                    loadingSpan.className = 'loading-text';
                    loadingSpan.textContent = 'Generazione risposta...';
                    contentDiv.appendChild(loadingSpan);
                } else if (message.role === 'assistant') {
                    contentDiv.innerHTML = renderMarkdown(message.content);
                } else {
                    contentDiv.textContent = message.content;
                }

                div.appendChild(roleDiv);
                div.appendChild(contentDiv);

                if (message.model && message.role === 'assistant' && message.cost > 0) {
                    const metaDiv = document.createElement('div');
                    metaDiv.className = 'message-meta';
                    const reasoningLabel = message.reasoning ? ` | Reasoning: ${message.reasoning}` : '';
                    const tokensLabel = (message.inputTokens || message.outputTokens)
                        ? ` | ${message.inputTokens ?? '?'}‚Üí${message.outputTokens ?? '?'} tok`
                        : '';
                    metaDiv.textContent = `${message.model} | $${message.cost.toFixed(6)}${tokensLabel}${reasoningLabel}`;
                    div.appendChild(metaDiv);
                }

                return div;
            }

            renderMessages(messages) {
                const container = document.getElementById('messages');
                container.innerHTML = '';

                if (messages.length === 0) {
                    container.innerHTML = `<p style="text-align: center; padding: 40px; color: #666;">${this.t('chat.empty')}</p>`;
                    this.currentMessageIndex = -1;
                    this.updateNavButtons();
                    return;
                }

                messages.forEach(msg => {
                    container.appendChild(this.renderMessage(msg));
                });

                if (this.currentMessageIndex < 0 || this.currentMessageIndex >= messages.length) {
                    this.currentMessageIndex = messages.length - 1;
                }

                this.scrollToBottom();
                this.updateNavButtons();
            }

            updateLastMessage(content) {
                const container = document.getElementById('messages');
                const lastMsg = container.lastElementChild;

                if (lastMsg && lastMsg.classList.contains('assistant')) {
                    const contentDiv = lastMsg.querySelector('.message-content');
                    if (contentDiv) {
                        contentDiv.innerHTML = renderMarkdown(content);
                    }
                }

                this.scrollToBottom();
            }

            scrollToBottom() {
                if (this.autoScroll) {
                    const container = document.getElementById('messagesContainer');
                    container.scrollTop = container.scrollHeight;
                }
            }

            scrollToMessage(index) {
                const messages = document.querySelectorAll('.message');
                if (index >= 0 && index < messages.length) {
                    this.currentMessageIndex = index;
                    const message = messages[index];
                    message.scrollIntoView({ behavior: 'auto', block: 'start' });
                    this.updateNavButtons();
                }
            }

            prevMessage() {
                const messages = document.querySelectorAll('.message');
                if (messages.length === 0) return;

                if (this.currentMessageIndex <= 0) {
                    this.currentMessageIndex = 0;
                } else {
                    this.currentMessageIndex--;
                }
                this.scrollToMessage(this.currentMessageIndex);
            }

            nextMessage() {
                const messages = document.querySelectorAll('.message');
                if (messages.length === 0) return;

                if (this.currentMessageIndex >= messages.length - 1) {
                    this.currentMessageIndex = messages.length - 1;
                } else {
                    this.currentMessageIndex++;
                }
                this.scrollToMessage(this.currentMessageIndex);
            }

            updateNavButtons() {
                const messages = document.querySelectorAll('.message');
                const prevBtn = document.getElementById('prevMsg');
                const nextBtn = document.getElementById('nextMsg');

                if (prevBtn && nextBtn) {
                    prevBtn.disabled = this.currentMessageIndex <= 0;
                    nextBtn.disabled = this.currentMessageIndex >= messages.length - 1;
                }
            }

            toggleAutoScroll() {
                this.autoScroll = !this.autoScroll;
                localStorage.setItem('autoScroll_online', this.autoScroll.toString());

                const btn = document.getElementById('autoScrollToggle');
                if (btn) {
                    if (this.autoScroll) {
                        btn.classList.add('active');
                        btn.title = 'Auto-scroll: ON';
                    } else {
                        btn.classList.remove('active');
                        btn.title = 'Auto-scroll: OFF';
                    }
                }
            }

            loadAutoScroll() {
                const saved = localStorage.getItem('autoScroll_online');
                if (saved !== null) {
                    this.autoScroll = saved === 'true';
                }

                const btn = document.getElementById('autoScrollToggle');
                if (btn && this.autoScroll) {
                    btn.classList.add('active');
                    btn.title = 'Auto-scroll: ON';
                } else if (btn) {
                    btn.title = 'Auto-scroll: OFF';
                }
            }

            increaseFontSize() {
                if (this.fontSize < 24) {
                    this.fontSize += 2;
                    this.applyFontSize();
                }
            }

            decreaseFontSize() {
                if (this.fontSize > 12) {
                    this.fontSize -= 2;
                    this.applyFontSize();
                }
            }

            applyFontSize() {
                document.body.style.fontSize = this.fontSize + 'px';
                localStorage.setItem('fontSize_online', this.fontSize.toString());
            }

            loadFontSize() {
                const saved = localStorage.getItem('fontSize_online');
                if (saved) {
                    this.fontSize = parseInt(saved);
                    this.applyFontSize();
                }
            }
        }

        // ===== MAIN APP CLASS =====
        class App {
            constructor() {
                this.langStorageKey = 'lang_online';
                this.lang = this.getInitialLanguage();
                this.apiKeyManager = new ApiKeyManager();
                this.modelSelector = new ModelSelector(MODELS);
                this.conversationManager = new ConversationManager();
                this.chatUI = new ChatUI((key, vars) => this.t(key, vars));
                this.chatCore = null;
                this.pageView = { pages: [], index: 0 };
                this.pageMeasureEl = null;
                this.pageFontSize = 16;
                this.pageFontStorageKey = 'pageFontSize_online';
                this.guideSteps = [];
                this.guideIndex = 0;
                this.currentGuideTarget = null;
                this.reasoningStorageKey = 'reasoningEnabled_online';
                this.reasoningEffortKey = 'reasoningEffort_online';
                this.reasoningToastTimer = null;

                this.init();
            }

            init() {
                this.setupApiKeyScreen();
                this.setupLanguageToggle();
                this.applyTranslations();

                if (this.apiKeyManager.hasApiKey()) {
                    this.showApp();
                    this.updateCreditDisplay();
                } else {
                    this.showSetupScreen();
                }
            }

            getInitialLanguage() {
                const saved = localStorage.getItem(this.langStorageKey);
                if (saved === 'it' || saved === 'en') {
                    return saved;
                }
                return 'en';
            }

            getLangPack() {
                return I18N[this.lang] || I18N.it;
            }

            t(key, vars) {
                const pack = this.getLangPack();
                const value = key.split('.').reduce((acc, part) => (acc ? acc[part] : undefined), pack);
                const fallback = key.split('.').reduce((acc, part) => (acc ? acc[part] : undefined), I18N.it);
                const text = value ?? fallback ?? key;
                if (!vars) return text;
                return text.replace(/\{(\w+)\}/g, (_, name) => (vars[name] ?? `{${name}}`));
            }

            setupLanguageToggle() {
                const btn = document.getElementById('langToggle');
                if (!btn) return;
                btn.addEventListener('click', () => this.toggleLanguage());
                const setupEn = document.getElementById('setupLangEn');
                const setupIt = document.getElementById('setupLangIt');
                if (setupEn) {
                    setupEn.addEventListener('click', () => this.setLanguage('en'));
                }
                if (setupIt) {
                    setupIt.addEventListener('click', () => this.setLanguage('it'));
                }
                this.updateLanguageControls();
            }

            updateLanguageControls() {
                const btn = document.getElementById('langToggle');
                if (!btn) return;
                btn.textContent = this.lang.toUpperCase();
                const setupEn = document.getElementById('setupLangEn');
                const setupIt = document.getElementById('setupLangIt');
                if (setupEn) setupEn.classList.toggle('active', this.lang === 'en');
                if (setupIt) setupIt.classList.toggle('active', this.lang === 'it');
            }

            toggleLanguage() {
                const next = this.lang === 'it' ? 'en' : 'it';
                this.setLanguage(next);
            }

            setLanguage(lang) {
                if (lang !== 'it' && lang !== 'en') return;
                this.lang = lang;
                localStorage.setItem(this.langStorageKey, lang);
                this.updateLanguageControls();
                this.chatUI.setTranslator((key, vars) => this.t(key, vars));
                this.applyTranslations();
                this.chatUI.renderMessages(this.conversationManager.getCurrentMessages());
                if (document.getElementById('pageModal').classList.contains('active')) {
                    this.rebuildPageViewPreservingMessage();
                }
            }

            applyTranslations() {
                document.title = this.t('docTitle');

                document.querySelectorAll('[data-i18n]').forEach((el) => {
                    el.textContent = this.t(el.getAttribute('data-i18n'));
                });

                document.querySelectorAll('[data-i18n-html]').forEach((el) => {
                    el.innerHTML = this.t(el.getAttribute('data-i18n-html'));
                });

                document.querySelectorAll('[data-i18n-placeholder]').forEach((el) => {
                    el.setAttribute('placeholder', this.t(el.getAttribute('data-i18n-placeholder')));
                });

                document.querySelectorAll('[data-i18n-title]').forEach((el) => {
                    el.setAttribute('title', this.t(el.getAttribute('data-i18n-title')));
                });

                document.querySelectorAll('[data-i18n-aria-label]').forEach((el) => {
                    el.setAttribute('aria-label', this.t(el.getAttribute('data-i18n-aria-label')));
                });

                this.applyPromptToggleLanguage();
                this.applyBottomToggleLanguage();
            }

            setupApiKeyScreen() {
                document.getElementById('saveApiKeyBtn').addEventListener('click', () => {
                    const input = document.getElementById('apiKeyInput');
                    const key = input.value.trim();
                    if (key) {
                        this.apiKeyManager.setApiKey(key);
                        this.showApp();
                    } else {
                        alert(this.t('errors.invalidKey'));
                    }
                });

                document.getElementById('apiKeyInput').addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        document.getElementById('saveApiKeyBtn').click();
                    }
                });

                // Refresh credit on setup screen (click on display)
                document.getElementById('setupCredit').addEventListener('click', () => {
                    this.updateCreditDisplay();
                });

                document.getElementById('setupCloseBtn').addEventListener('click', () => {
                    this.hideSetupOverlay();
                });

                document.getElementById('setupHideBtn').addEventListener('click', () => {
                    this.hideSetupOverlay();
                });

                document.getElementById('setupTourBtn').addEventListener('click', () => {
                    this.startTourFromOverlay();
                });

                document.getElementById('demoBannerBtn').addEventListener('click', () => {
                    this.showSetupOverlay();
                });

                document.getElementById('demoTourBtn').addEventListener('click', () => {
                    this.startTour();
                });

                document.getElementById('guideCloseBtn').addEventListener('click', () => {
                    this.closeGuide();
                });
            }

            showSetupScreen() {
                document.getElementById('app').classList.add('active');
                this.setDemoMode(true);
                this.showSetupOverlay();
                this.updateCreditDisplay();
            }

            showApp() {
                document.getElementById('app').classList.add('active');
                this.setDemoMode(false);
                this.hideSetupOverlay();

                this.setupEventListeners();
                this.populateModelSelector();
                this.setupPromptToggle();
                this.setupBottomToggle();
                this.setupNotice();
                this.updateReasoningAvailability();

                this.chatCore = new ChatCore(
                    this.modelSelector,
                    this.apiKeyManager,
                    (content) => this.chatUI.updateLastMessage(content)
                );
                this.startNewChat();
            }

            showSetupOverlay() {
                const overlay = document.getElementById('setupScreen');
                overlay.classList.add('active');
                overlay.setAttribute('aria-hidden', 'false');
                overlay.removeAttribute('inert');
            }

            hideSetupOverlay() {
                const overlay = document.getElementById('setupScreen');
                overlay.classList.remove('active');
                overlay.setAttribute('aria-hidden', 'true');
                overlay.setAttribute('inert', '');

                const active = document.activeElement;
                if (active && overlay.contains(active)) {
                    const fallback =
                        document.getElementById('demoBannerBtn') ||
                        document.getElementById('apiKeyBtn') ||
                        document.getElementById('messageInput');
                    if (fallback) {
                        fallback.focus();
                    } else {
                        active.blur();
                    }
                }
            }

            setDemoMode(enabled) {
                const banner = document.getElementById('demoBanner');
                banner.classList.toggle('active', enabled);

                const inputs = [
                    document.getElementById('messageInput'),
                    document.getElementById('sendBtn'),
                    document.getElementById('systemPrompt'),
                    document.getElementById('contextPrompt'),
                    document.getElementById('examplesPrompt')
                ];
                inputs.forEach((el) => {
                    if (el) el.disabled = enabled;
                });
            }

            setupEventListeners() {
                // Send button
                document.getElementById('sendBtn').addEventListener('click', () => this.sendMessage());

                // Enter key
                document.getElementById('messageInput').addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });

                // New chat button
                document.getElementById('newChatBtn').addEventListener('click', () => this.startNewChat());
                document.getElementById('cloneChatBtn').addEventListener('click', () => this.cloneChat());
                document.getElementById('homeBtn').addEventListener('click', () => {
                    window.location.href = '/';
                });

                // API Key button
                document.getElementById('apiKeyBtn').addEventListener('click', () => {
                    if (!this.apiKeyManager.hasApiKey()) {
                        this.showSetupOverlay();
                        return;
                    }
                    if (confirm(this.t('errors.changeKeyConfirm'))) {
                        this.apiKeyManager.clearApiKey();
                        this.showSetupScreen();
                    }
                });

                // Credit display (click to refresh)
                document.getElementById('creditDisplay').addEventListener('click', () => {
                    this.updateCreditDisplay();
                });

                // Model selector
                document.getElementById('modelSelector').addEventListener('change', (e) => {
                    this.modelSelector.selectModel(e.target.value);
                    this.updateReasoningAvailability();
                });

                // Font size controls
                document.getElementById('fontIncrease').addEventListener('click', () => {
                    this.chatUI.increaseFontSize();
                });
                document.getElementById('fontDecrease').addEventListener('click', () => {
                    this.chatUI.decreaseFontSize();
                });

                // Navigation controls
                document.getElementById('prevMsg').addEventListener('click', () => {
                    this.chatUI.prevMessage();
                });
                document.getElementById('nextMsg').addEventListener('click', () => {
                    this.chatUI.nextMessage();
                });

                // Auto-scroll toggle
                document.getElementById('autoScrollToggle').addEventListener('click', () => {
                    this.chatUI.toggleAutoScroll();
                });

                // Export button
                document.getElementById('exportBtn').addEventListener('click', () => {
                    this.exportChat();
                });

                // History button
                document.getElementById('historyBtn').addEventListener('click', () => {
                    this.showHistory();
                });

                // Tour button
                document.getElementById('tourBtn').addEventListener('click', () => {
                    this.startTour();
                });

                // Page view button
                document.getElementById('pageViewBtn').addEventListener('click', () => {
                    this.showPageView();
                });

                document.getElementById('pagePrevBtn').addEventListener('click', () => {
                    this.changePageView(-1);
                });

                document.getElementById('pageNextBtn').addEventListener('click', () => {
                    this.changePageView(1);
                });

                document.getElementById('pageFontIncrease').addEventListener('click', () => {
                    this.increasePageFontSize();
                });

                document.getElementById('pageFontDecrease').addEventListener('click', () => {
                    this.decreasePageFontSize();
                });

                // Reasoning toggle
                document.getElementById('reasoningToggle').addEventListener('click', () => {
                    if (!this.isReasoningSupported()) return;
                    const enabled = !this.getReasoningEnabled();
                    this.setReasoningEnabled(enabled);
                });
                document.getElementById('reasoningToggle').addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    this.cycleReasoningEffort();
                });

                document.addEventListener('keydown', (e) => {
                    if (e.altKey && e.shiftKey && e.key.toLowerCase() === 'r') {
                        this.cycleReasoningEffort();
                    }
                });

                this.attachPromptListeners();
            }

            setupPromptToggle() {
                const btn = document.getElementById('promptToggle');
                if (!btn) return;

                const applyState = (collapsed) => {
                    document.body.classList.toggle('prompt-collapsed', collapsed);
                    btn.setAttribute('aria-expanded', (!collapsed).toString());
                    localStorage.setItem('promptCollapsed_online', collapsed ? 'true' : 'false');
                    this.applyPromptToggleLanguage();
                };

                const saved = localStorage.getItem('promptCollapsed_online');
                if (saved !== null) {
                    applyState(saved === 'true');
                }

                btn.addEventListener('click', () => {
                    const collapsed = !document.body.classList.contains('prompt-collapsed');
                    applyState(collapsed);
                });
            }

            applyPromptToggleLanguage() {
                const btn = document.getElementById('promptToggle');
                if (!btn) return;
                const collapsed = document.body.classList.contains('prompt-collapsed');
                btn.textContent = collapsed ? this.t('floating.promptToggleCollapsed') : this.t('floating.promptToggle');
                btn.title = collapsed ? this.t('floating.promptToggleShow') : this.t('floating.promptToggleTitle');
            }

            setupBottomToggle() {
                const btn = document.getElementById('bottomToggle');
                if (!btn) return;

                const applyState = (collapsed) => {
                    document.body.classList.toggle('bottom-collapsed', collapsed);
                    btn.setAttribute('aria-expanded', (!collapsed).toString());
                    localStorage.setItem('bottomCollapsed_online', collapsed ? 'true' : 'false');
                    this.applyBottomToggleLanguage();
                };

                const saved = localStorage.getItem('bottomCollapsed_online');
                if (saved !== null) {
                    applyState(saved === 'true');
                }

                btn.addEventListener('click', () => {
                    const collapsed = !document.body.classList.contains('bottom-collapsed');
                    applyState(collapsed);
                });
            }

            applyBottomToggleLanguage() {
                const btn = document.getElementById('bottomToggle');
                if (!btn) return;
                const collapsed = document.body.classList.contains('bottom-collapsed');
                btn.textContent = collapsed ? this.t('floating.bottomToggleCollapsed') : this.t('floating.bottomToggleExpanded');
                btn.title = collapsed ? this.t('floating.bottomToggleShow') : this.t('floating.bottomToggleTitle');
            }

            populateModelSelector() {
                const select = document.getElementById('modelSelector');
                select.innerHTML = '';

                this.modelSelector.getModels().forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.id;
                    option.textContent = model.name;
                    select.appendChild(option);
                });

                select.value = this.modelSelector.getCurrentModel().id;
            }

            startNewChat() {
                this.conversationManager.saveConversation();
                this.conversationManager.newConversation();
                this.chatUI.renderMessages([]);
                document.getElementById('messageInput').value = '';
                this.applyPromptFields({
                    systemPrompt: '',
                    contextPrompt: '',
                    examplesPrompt: ''
                });
            }

            cloneChat() {
                this.conversationManager.saveConversation();
                const promptFields = this.getPromptFieldsFromInputs();
                this.conversationManager.newConversation(promptFields);
                this.chatUI.renderMessages([]);
                document.getElementById('messageInput').value = '';
                this.applyPromptFields(promptFields);
            }

            getPromptFieldsFromInputs() {
                return {
                    systemPrompt: document.getElementById('systemPrompt').value.trim(),
                    contextPrompt: document.getElementById('contextPrompt').value.trim(),
                    examplesPrompt: document.getElementById('examplesPrompt').value.trim()
                };
            }

            async sendMessage() {
                const input = document.getElementById('messageInput');
                const content = input.value.trim();

                if (!content) return;
                if (!this.apiKeyManager.hasApiKey()) {
                    alert(this.t('errors.missingKey'));
                    this.showSetupOverlay();
                    return;
                }

                // Add user message
                const userMessage = { role: 'user', content: content };
                this.conversationManager.addMessage(userMessage);

                // Create placeholder for assistant
                const reasoningEnabled = this.getReasoningEnabled();
                const reasoningEffort = this.getReasoningEffort();
                const assistantMessage = {
                    role: 'assistant',
                    content: '',
                    model: this.modelSelector.getCurrentModel().name,
                    cost: 0,
                    reasoning: reasoningEnabled ? reasoningEffort : ''
                };
                this.conversationManager.addMessage(assistantMessage);

                // Clear input and render
                input.value = '';
                this.chatUI.renderMessages(this.conversationManager.getCurrentMessages());
                document.getElementById('sendBtn').disabled = true;

                // Send to API
                const promptMessages = this.buildPromptMessages();
                const historyMessages = this.conversationManager.getCurrentMessages().slice(0, -1);
                const payloadMessages = [...promptMessages, ...historyMessages];
                const options = this.getReasoningPayloadOptions();
                await this.chatCore.sendMessage(
                    payloadMessages,
                    options,
                    (fullContent, cost, inputTokens, outputTokens) => {
                        // Update assistant message
                        const messages = this.conversationManager.getCurrentMessages();
                        const lastMsg = messages[messages.length - 1];
                        lastMsg.content = fullContent;
                        lastMsg.cost = cost;
                        lastMsg.inputTokens = inputTokens;
                        lastMsg.outputTokens = outputTokens;

                        this.conversationManager.saveConversation();

                        // Re-render per mostrare il costo finale
                        this.chatUI.renderMessages(messages);
                        document.getElementById('sendBtn').disabled = false;

                    },
                    (error) => {
                        alert(this.t('errors.generic', { message: error.message }));
                        console.error(error);

                        // Remove failed assistant message
                        const messages = this.conversationManager.getCurrentMessages();
                        messages.pop();
                        this.chatUI.renderMessages(messages);
                        document.getElementById('sendBtn').disabled = false;
                    }
                );
            }

            isReasoningSupported() {
                return true;
            }

            getReasoningEnabled() {
                return localStorage.getItem(this.reasoningStorageKey) === 'true';
            }

            setReasoningEnabled(enabled) {
                localStorage.setItem(this.reasoningStorageKey, enabled ? 'true' : 'false');
                this.applyReasoningState(enabled);
            }

            applyReasoningState(enabled) {
                const btn = document.getElementById('reasoningToggle');
                if (!btn) return;
                btn.classList.toggle('active', enabled);
                const effort = this.getReasoningEffort();
                btn.title = enabled ? `Reasoning: ON (${effort})` : 'Reasoning: OFF';
            }

            updateReasoningAvailability() {
                const btn = document.getElementById('reasoningToggle');
                if (!btn) return;

                btn.classList.remove('hidden');
                this.applyReasoningState(this.getReasoningEnabled());
            }

            getReasoningPayloadOptions() {
                if (!this.isReasoningSupported() || !this.getReasoningEnabled()) {
                    return {};
                }
                return {
                    reasoning: { effort: this.getReasoningEffort() },
                    reasoning_details: true
                };
            }

            getReasoningEffort() {
                const effort = localStorage.getItem(this.reasoningEffortKey);
                if (effort === 'medium' || effort === 'high') {
                    return effort;
                }
                return 'low';
            }

            setReasoningEffort(effort) {
                localStorage.setItem(this.reasoningEffortKey, effort);
                this.applyReasoningState(this.getReasoningEnabled());
            }

            cycleReasoningEffort() {
                if (!this.isReasoningSupported()) return;
                const current = this.getReasoningEffort();
                const next = current === 'low' ? 'medium' : current === 'medium' ? 'high' : 'low';
                this.setReasoningEffort(next);
                this.showReasoningToast(next);
            }

            showReasoningToast(level) {
                const toast = document.getElementById('reasoningToast');
                if (!toast) return;
                toast.textContent = `Reasoning: ${level}`;
                toast.classList.remove('hidden');
                if (this.reasoningToastTimer) {
                    clearTimeout(this.reasoningToastTimer);
                }
                this.reasoningToastTimer = setTimeout(() => {
                    toast.classList.add('hidden');
                }, 1400);
            }

            loadConversation(id) {
                const conv = this.conversationManager.loadConversation(id);
                if (conv) {
                    this.chatUI.renderMessages(conv.messages);
                    this.applyPromptFields(conv.promptFields);
                    this.closeHistory();
                }
            }
            attachPromptListeners() {
                const fields = ['systemPrompt', 'contextPrompt', 'examplesPrompt'];
                fields.forEach((id) => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.addEventListener('input', () => this.savePromptFields());
                    }
                });
            }

            savePromptFields() {
                const data = {
                    systemPrompt: document.getElementById('systemPrompt').value.trim(),
                    contextPrompt: document.getElementById('contextPrompt').value.trim(),
                    examplesPrompt: document.getElementById('examplesPrompt').value.trim()
                };
                if (this.conversationManager.currentConversation) {
                    this.conversationManager.currentConversation.promptFields = data;
                    this.conversationManager.saveConversation();
                }
            }

            applyPromptFields(data) {
                document.getElementById('systemPrompt').value = data.systemPrompt || '';
                document.getElementById('contextPrompt').value = data.contextPrompt || '';
                document.getElementById('examplesPrompt').value = data.examplesPrompt || '';
                if (this.conversationManager.currentConversation) {
                    this.conversationManager.currentConversation.promptFields = {
                        systemPrompt: document.getElementById('systemPrompt').value.trim(),
                        contextPrompt: document.getElementById('contextPrompt').value.trim(),
                        examplesPrompt: document.getElementById('examplesPrompt').value.trim()
                    };
                    this.conversationManager.saveConversation();
                }
            }

            buildPromptMessages() {
                const systemPrompt = document.getElementById('systemPrompt').value.trim();
                const contextPrompt = document.getElementById('contextPrompt').value.trim();
                const examplesPrompt = document.getElementById('examplesPrompt').value.trim();

                const sections = [];
                if (systemPrompt) {
                    sections.push(`<SYSTEM_PROMPT>\n${systemPrompt}\n</SYSTEM_PROMPT>`);
                }
                if (contextPrompt) {
                    sections.push(`<CONTEXT>\n${contextPrompt}\n</CONTEXT>`);
                }
                if (examplesPrompt) {
                    sections.push(`<DATI>\n${examplesPrompt}\n</DATI>`);
                }

                if (sections.length === 0) {
                    return [];
                }

                return [{ role: 'system', content: sections.join('\n\n') }];
            }

            showHistory() {
                const historyList = document.getElementById('historyList');
                historyList.innerHTML = '';
                document.getElementById('historyModal').classList.add('active');

                const conversations = this.conversationManager.getAllConversations();

                if (conversations.length === 0) {
                    const noConvDiv = document.createElement('div');
                    noConvDiv.style.textAlign = 'center';
                    noConvDiv.style.padding = '20px';
                    noConvDiv.style.color = '#666';
                    noConvDiv.textContent = this.t('history.empty');
                    historyList.appendChild(noConvDiv);
                    return;
                }

                conversations.forEach(conv => {
                    const item = document.createElement('div');
                    item.className = 'conversation-item';

                    const title = document.createElement('div');
                    title.className = 'conversation-title';
                    title.textContent = conv.title;

                    const meta = document.createElement('div');
                    meta.className = 'conversation-meta';
                    const date = new Date(conv.createdAt);
                    const locale = this.lang === 'it' ? 'it-IT' : 'en-US';
                    meta.textContent = `${conv.messages.length} ${this.t('history.messagesLabel')} ‚Ä¢ ${date.toLocaleDateString(locale)} ${date.toLocaleTimeString(locale, { hour: '2-digit', minute: '2-digit' })}`;

                    item.appendChild(title);
                    item.appendChild(meta);

                    item.addEventListener('click', () => {
                        this.loadConversation(conv.id);
                    });

                    historyList.appendChild(item);
                });
            }

            closeHistory() {
                document.getElementById('historyModal').classList.remove('active');
            }

            startTour() {
                this.guideSteps = [
                    {
                        element: '#apiKeyBtn',
                        title: this.t('guide.step1Title'),
                        description: this.t('guide.step1Desc')
                    },
                    {
                        element: '#modelSelector',
                        title: this.t('guide.step2Title'),
                        description: this.t('guide.step2Desc')
                    },
                    {
                        element: '#systemPrompt',
                        title: this.t('guide.step3Title'),
                        description: this.t('guide.step3Desc')
                    },
                    {
                        element: '#contextPrompt',
                        title: this.t('guide.step4Title'),
                        description: this.t('guide.step4Desc')
                    },
                    {
                        element: '#examplesPrompt',
                        title: this.t('guide.step5Title'),
                        description: this.t('guide.step5Desc')
                    },
                    {
                        element: '#messageInput',
                        title: this.t('guide.step6Title'),
                        description: this.t('guide.step6Desc')
                    },
                    {
                        element: '#sendBtn',
                        title: this.t('guide.step7Title'),
                        description: this.t('guide.step7Desc')
                    },
                    {
                        element: '#pageViewBtn',
                        title: this.t('guide.step8Title'),
                        description: this.t('guide.step8Desc')
                    },
                    {
                        element: '#fontIncrease',
                        title: this.t('guide.step9Title'),
                        description: this.t('guide.step9Desc')
                    },
                    {
                        element: '#newChatBtn',
                        title: this.t('guide.step10Title'),
                        description: this.t('guide.step10Desc')
                    }
                ];
                this.openGuide(0);
            }

            startTourFromOverlay() {
                this.hideSetupOverlay();
                requestAnimationFrame(() => {
                    this.startTour();
                });
            }

            openGuide(index) {
                const overlay = document.getElementById('guideOverlay');
                overlay.classList.add('active');
                overlay.setAttribute('aria-hidden', 'false');
                this.renderGuideStep(index);
            }

            closeGuide() {
                const overlay = document.getElementById('guideOverlay');
                overlay.classList.remove('active');
                overlay.setAttribute('aria-hidden', 'true');
                this.clearGuideHighlight();
            }

            moveGuide(delta) {
                const next = Math.max(0, Math.min(this.guideSteps.length - 1, this.guideIndex + delta));
                this.renderGuideStep(next);
            }

            renderGuideStep(index) {
                if (!this.guideSteps.length) return;
                this.guideIndex = index;
                const step = this.guideSteps[index];
                const titleEl = document.getElementById('guideTitle');
                const descEl = document.getElementById('guideDesc');
                const prevBtn = document.getElementById('guidePrevBtn');
                const nextBtn = document.getElementById('guideNextBtn');

                titleEl.textContent = step.title;
                descEl.textContent = step.description;
                prevBtn.disabled = index === 0;
                nextBtn.textContent = index === this.guideSteps.length - 1 ? this.t('guide.done') : this.t('guide.next');
                prevBtn.onclick = () => this.moveGuide(-1);

                if (index === this.guideSteps.length - 1) {
                    nextBtn.classList.remove('primary');
                } else {
                    nextBtn.classList.add('primary');
                }

                if (index === this.guideSteps.length - 1) {
                    nextBtn.onclick = () => this.closeGuide();
                } else {
                    nextBtn.onclick = () => this.moveGuide(1);
                }

                this.applyGuideHighlight(step.element);
            }

            applyGuideHighlight(selector) {
                this.clearGuideHighlight();
                const el = document.querySelector(selector);
                if (!el) return;
                el.classList.add('guide-highlight');
                el.scrollIntoView({ behavior: 'auto', block: 'center' });
                this.currentGuideTarget = el;
            }

            clearGuideHighlight() {
                if (this.currentGuideTarget) {
                    this.currentGuideTarget.classList.remove('guide-highlight');
                    this.currentGuideTarget = null;
                }
            }

            showPageView() {
                const modal = document.getElementById('pageModal');
                modal.classList.add('active');
                modal.setAttribute('aria-hidden', 'false');
                requestAnimationFrame(() => {
                    this.loadPageFontSize();
                    this.buildPageViewPages();
                    this.renderPageViewPage(0);
                });
            }

            closePageView() {
                const modal = document.getElementById('pageModal');
                modal.classList.remove('active');
                modal.setAttribute('aria-hidden', 'true');
            }

            changePageView(delta) {
                if (!this.pageView.pages.length) return;
                const nextIndex = Math.max(0, Math.min(this.pageView.pages.length - 1, this.pageView.index + delta));
                this.renderPageViewPage(nextIndex);
            }

            getPageMeasureElement() {
                if (this.pageMeasureEl) return this.pageMeasureEl;
                const el = document.createElement('div');
                el.className = 'page-body page-measure';
                document.body.appendChild(el);
                this.pageMeasureEl = el;
                this.applyPageFontSize();
                return el;
            }

            applyPageFontSize() {
                const pageBody = document.getElementById('pageBody');
                if (pageBody) {
                    pageBody.style.fontSize = `${this.pageFontSize}px`;
                }
                if (this.pageMeasureEl) {
                    this.pageMeasureEl.style.fontSize = `${this.pageFontSize}px`;
                }
                localStorage.setItem(this.pageFontStorageKey, this.pageFontSize.toString());
            }

            loadPageFontSize() {
                const saved = localStorage.getItem(this.pageFontStorageKey);
                if (saved) {
                    const parsed = parseInt(saved, 10);
                    if (!Number.isNaN(parsed)) {
                        this.pageFontSize = parsed;
                    }
                }
                this.applyPageFontSize();
            }

            increasePageFontSize() {
                if (this.pageFontSize < 26) {
                    this.pageFontSize += 2;
                    this.applyPageFontSize();
                    this.rebuildPageViewPreservingMessage();
                }
            }

            decreasePageFontSize() {
                if (this.pageFontSize > 12) {
                    this.pageFontSize -= 2;
                    this.applyPageFontSize();
                    this.rebuildPageViewPreservingMessage();
                }
            }

            rebuildPageViewPreservingMessage() {
                if (!document.getElementById('pageModal').classList.contains('active')) {
                    return;
                }
                const currentPage = this.pageView.pages[this.pageView.index];
                const targetMessageIndex = currentPage ? currentPage.messageIndex : 0;
                this.buildPageViewPages();
                const targetIndex = this.pageView.pages.findIndex(p => p.messageIndex === targetMessageIndex);
                const fallbackIndex = targetIndex >= 0 ? targetIndex : 0;
                this.renderPageViewPage(fallbackIndex);
            }

            buildPageViewPages() {
                const messages = this.conversationManager.getCurrentMessages();
                const pageBody = document.getElementById('pageBody');
                const measureEl = this.getPageMeasureElement();
                const maxHeight = pageBody.clientHeight || 300;
                const maxWidth = pageBody.clientWidth || 400;
                measureEl.style.width = `${maxWidth}px`;

                const pages = [];
                messages.forEach((message, messageIndex) => {
                    const rawText = (message.content && message.content.trim())
                        ? message.content
                        : (message.role === 'assistant' ? 'Generazione risposta...' : '');
                    const chunks = this.paginateTextToPages(rawText, maxHeight, measureEl);
                    const pageCount = Math.max(chunks.length, 1);
                    const finalChunks = chunks.length ? chunks : [''];

                    finalChunks.forEach((chunk, pageIndex) => {
                        pages.push({
                            messageIndex,
                            messageCount: messages.length,
                            pageIndex,
                            pageCount,
                            role: message.role,
                            model: message.model,
                            cost: message.cost,
                            inputTokens: message.inputTokens,
                            outputTokens: message.outputTokens,
                            reasoning: message.reasoning,
                            content: chunk
                        });
                    });
                });

                this.pageView.pages = pages;
                this.pageView.index = 0;
            }

            paginateTextToPages(text, maxHeight, measureEl) {
                const trimmed = (text || '').trim();
                if (!trimmed) return [''];

                const paragraphs = trimmed.split(/\n{2,}/).filter(p => p.trim().length > 0);
                const pages = [];
                let current = '';

                const fits = (content) => {
                    measureEl.innerHTML = renderMarkdown(content);
                    return measureEl.scrollHeight <= maxHeight;
                };

                const pushCurrent = () => {
                    if (current.trim().length > 0) {
                        pages.push(current.trim());
                    }
                    current = '';
                };

                for (const paragraph of paragraphs) {
                    const candidate = current ? `${current}\n\n${paragraph}` : paragraph;
                    if (fits(candidate)) {
                        current = candidate;
                        continue;
                    }

                    if (current) {
                        pushCurrent();
                    }

                    if (!fits(paragraph)) {
                        const wordPages = this.splitParagraphByWords(paragraph, maxHeight, measureEl);
                        pages.push(...wordPages);
                    } else {
                        current = paragraph;
                    }
                }

                if (current) {
                    pushCurrent();
                }

                return pages.length ? pages : [''];
            }

            splitParagraphByWords(paragraph, maxHeight, measureEl) {
                const words = paragraph.split(/\s+/).filter(Boolean);
                const pages = [];
                let chunk = '';

                const fits = (content) => {
                    measureEl.innerHTML = renderMarkdown(content);
                    return measureEl.scrollHeight <= maxHeight;
                };

                for (const word of words) {
                    const candidate = chunk ? `${chunk} ${word}` : word;
                    if (fits(candidate)) {
                        chunk = candidate;
                    } else {
                        if (chunk) {
                            pages.push(chunk);
                        }
                        chunk = word;
                    }
                }

                if (chunk) {
                    pages.push(chunk);
                }

                return pages;
            }

            renderPageViewPage(index) {
                const pageBody = document.getElementById('pageBody');
                const meta = document.getElementById('pageMeta');
                const extra = document.getElementById('pageExtra');
                const counter = document.getElementById('pageCounter');
                const prevBtn = document.getElementById('pagePrevBtn');
                const nextBtn = document.getElementById('pageNextBtn');

                if (!this.pageView.pages.length) {
                    pageBody.innerHTML = `<div class="page-empty">${this.t('chat.empty')}</div>`;
                    meta.textContent = this.t('pages.noMessage');
                    extra.textContent = '';
                    counter.textContent = this.t('pages.counter', { current: 0, total: 0 });
                    prevBtn.disabled = true;
                    nextBtn.disabled = true;
                    return;
                }

                const safeIndex = Math.max(0, Math.min(this.pageView.pages.length - 1, index));
                this.pageView.index = safeIndex;
                const page = this.pageView.pages[safeIndex];

                if (page.content && page.content.trim().length > 0) {
                    pageBody.innerHTML = renderMarkdown(page.content);
                } else {
                    pageBody.innerHTML = `<div class="page-empty">${this.t('pages.emptyMessage')}</div>`;
                }

                const roleLabel = page.role === 'assistant' ? this.t('role.assistant') : this.t('role.user');
                meta.textContent = this.t('pages.meta', {
                    message: page.messageIndex + 1,
                    total: page.messageCount,
                    page: page.pageIndex + 1,
                    pages: page.pageCount,
                    role: roleLabel
                });

                if (page.role === 'assistant') {
                    const parts = [];
                    if (page.model) parts.push(page.model);
                    if (page.cost && page.cost > 0) parts.push(`$${page.cost.toFixed(6)}`);
                    if (page.inputTokens || page.outputTokens) {
                        parts.push(`${page.inputTokens ?? '?'}‚Üí${page.outputTokens ?? '?'} tok`);
                    }
                    if (page.reasoning) parts.push(`Reasoning: ${page.reasoning}`);
                    extra.textContent = parts.join(' ‚Ä¢ ');
                } else {
                    extra.textContent = '';
                }

                counter.textContent = this.t('pages.counter', { current: safeIndex + 1, total: this.pageView.pages.length });
                prevBtn.disabled = safeIndex <= 0;
                nextBtn.disabled = safeIndex >= this.pageView.pages.length - 1;
            }

            exportChat() {
                const conv = this.conversationManager.currentConversation;
                if (!conv) {
                    alert(this.t('errors.exportEmpty'));
                    return;
                }
                const data = {
                    id: conv.id,
                    title: conv.title,
                    createdAt: conv.createdAt,
                    promptFields: this.getPromptFieldsFromInputs(),
                    messages: conv.messages || []
                };
                const safeTitle = (conv.title || 'chat')
                    .replace(/[^a-z0-9-_]+/gi, '_')
                    .slice(0, 50);
                const baseName = `chat_${safeTitle || 'export'}_${conv.id}`;
                const markdown = this.buildMarkdownExport(data);
                this.downloadFile(`${baseName}.md`, markdown, 'text/markdown');
            }

            downloadFile(filename, content, mimeType) {
                const blob = new Blob([content], { type: mimeType });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                link.remove();
                URL.revokeObjectURL(url);
            }

            buildMarkdownExport(data) {
                const lines = [];
                lines.push(`# ${data.title || 'Chat'}`);
                if (data.createdAt) {
                    lines.push('');
                    lines.push(`${this.t('export.date')}: ${data.createdAt}`);
                }

                const prompts = data.promptFields || {};
                lines.push('');
                lines.push(`## ${this.t('export.prompt')}`);
                lines.push('');
                lines.push(`### ${this.t('export.system')}`);
                lines.push(prompts.systemPrompt || this.t('export.empty'));
                lines.push('');
                lines.push(`### ${this.t('export.context')}`);
                lines.push(prompts.contextPrompt || this.t('export.empty'));
                lines.push('');
                lines.push(`### ${this.t('export.examples')}`);
                lines.push(prompts.examplesPrompt || this.t('export.empty'));
                lines.push('');
                lines.push(`## ${this.t('export.messages')}`);
                lines.push('');

                (data.messages || []).forEach((msg, index) => {
                    const role = msg.role === 'assistant' ? this.t('export.assistant') : this.t('export.user');
                    lines.push(`### ${index + 1}. ${role}`);
                    lines.push(msg.content || this.t('export.empty'));
                    if (msg.model && msg.role === 'assistant') {
                        const reasoningLabel = msg.reasoning ? ` | Reasoning: ${msg.reasoning}` : '';
                        lines.push('');
                        lines.push(`_${this.t('export.modelLabel')}: ${msg.model} | ${this.t('export.costLabel')}: $${(msg.cost || 0).toFixed(6)}${reasoningLabel}_`);
                    }
                    lines.push('');
                });

                return lines.join('\n');
            }

            setupNotice() {
                const seen = localStorage.getItem('noticeSeen_online');
                if (!seen) {
                    document.getElementById('noticeModal').classList.add('active');
                }
            }

            acceptNotice() {
                localStorage.setItem('noticeSeen_online', 'true');
                this.closeNotice();
            }

            closeNotice() {
                document.getElementById('noticeModal').classList.remove('active');
            }

            // ===== CREDIT MANAGEMENT =====
            async fetchCredit() {
                const apiKey = this.apiKeyManager.getApiKey();
                if (!apiKey) return null;

                try {
                    const response = await fetch('https://openrouter.ai/api/v1/auth/key', {
                        headers: {
                            'Authorization': `Bearer ${apiKey}`
                        }
                    });

                    if (!response.ok) {
                        console.error('Failed to fetch credit:', response.status);
                        return null;
                    }

                    const data = await response.json();
                    // data.data.limit = credito totale (null se illimitato)
                    // data.data.usage = credito usato
                    // Credito residuo = limit - usage (o "illimitato" se limit √® null)
                    return data.data;
                } catch (error) {
                    console.error('Error fetching credit:', error);
                    return null;
                }
            }

            async updateCreditDisplay() {
                const creditData = await this.fetchCredit();

                const bottomDisplay = document.getElementById('creditDisplay');
                const setupDisplay = document.getElementById('setupCreditValue');
                const setupContainer = document.getElementById('setupCredit');

                if (!creditData) {
                    if (bottomDisplay) bottomDisplay.textContent = '$-.--';
                    if (setupDisplay) setupDisplay.textContent = '$-.--';
                    if (setupContainer) setupContainer.classList.add('hidden');
                    return;
                }

                let displayText;
                if (creditData.limit === null || creditData.limit === undefined) {
                    // Credito illimitato (pay as you go)
                    const usage = creditData.usage || 0;
                    displayText = this.t('credit.unlimited', { value: `$${usage.toFixed(2)}` });
                } else {
                    // Credito limitato
                    const remaining = (creditData.limit || 0) - (creditData.usage || 0);
                    displayText = this.t('credit.remaining', { value: `$${remaining.toFixed(2)}` });
                }

                if (bottomDisplay) bottomDisplay.textContent = displayText;
                if (setupDisplay) setupDisplay.textContent = displayText;
                if (setupContainer) setupContainer.classList.remove('hidden');
            }
        }

        // ===== START APP =====
        let app;
        document.addEventListener('DOMContentLoaded', () => {
            app = new App();
        });
    </script>
</body>
</html>
